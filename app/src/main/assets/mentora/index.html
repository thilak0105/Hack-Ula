<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="./favicon.ico"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="theme-color" content="#000000"/>
    <meta name="description" content="Web site created using create-react-app"/>
    <link rel="apple-touch-icon" href="./logo192.png"/>
    <link rel="manifest" href="./manifest.json"/>
    <title>React App</title>
    <script>
        // Android Bridge - Must load BEFORE React app
        console.log('[AndroidBridge] Initializing...');
        
        window.isAndroidApp = true;
        
        // Store pending requests
        const pendingXHR = new Map();
        let xhrId = 0;
        
        // Handler for website extraction results
        window.handleWebResult = function(id, result) {
            console.log('[AndroidBridge] Got result for request', id, result);
            const xhr = pendingXHR.get(id);
            if (!xhr) {
                console.error('[AndroidBridge] No XHR found for request', id);
                return;
            }
            
            // Create proper response structure matching frontend expectations
            const data = {
                success: result.success || false,
                course_id: 'android-' + Date.now(),
                extracted_text: result.text || '',
                course: {
                    title: result.title || 'Untitled Course',
                    description: 'Course created from extracted content',
                    modules: [
                        {
                            id: 'module-1',
                            title: 'Introduction',
                            description: 'Getting started',
                            duration: 60,
                            lessonCount: 2,
                            status: 'in-progress',
                            lessons: [
                                {
                                    id: 'lesson-1-1',
                                    title: 'What is ' + (result.title || 'this topic') + '?',
                                    description: 'Introduction and overview',
                                    duration: 30,
                                    status: 'in-progress'
                                },
                                {
                                    id: 'lesson-1-2',
                                    title: 'Key Concepts',
                                    description: 'Understanding the fundamentals',
                                    duration: 30,
                                    status: 'available'
                                }
                            ]
                        }
                    ]
                }
            };
            
            console.log('[AndroidBridge] Responding with:', data);
            const json = JSON.stringify(data);
            
            Object.defineProperty(xhr, 'readyState', {writable: true, value: 4});
            Object.defineProperty(xhr, 'status', {writable: true, value: result.success ? 200 : 500});
            Object.defineProperty(xhr, 'statusText', {writable: true, value: result.success ? 'OK' : 'Error'});
            Object.defineProperty(xhr, 'response', {writable: true, value: json});
            Object.defineProperty(xhr, 'responseText', {writable: true, value: json});
            Object.defineProperty(xhr, 'responseType', {writable: true, value: ''});
            
            xhr.getAllResponseHeaders = () => 'Content-Type: application/json\r\n';
            xhr.getResponseHeader = (n) => n.toLowerCase() === 'content-type' ? 'application/json' : null;
            
            console.log('[AndroidBridge] Triggering events...');
            
            // Trigger readystatechange first
            if (xhr.onreadystatechange) {
                try {
                    xhr.onreadystatechange({type: 'readystatechange', target: xhr});
                    console.log('[AndroidBridge] onreadystatechange triggered');
                } catch(e) {
                    console.error('[AndroidBridge] Error in onreadystatechange:', e);
                }
            }
            
            // Then trigger onload
            if (xhr.onload) {
                try {
                    xhr.onload({type: 'load', target: xhr, currentTarget: xhr});
                    console.log('[AndroidBridge] onload triggered');
                } catch(e) {
                    console.error('[AndroidBridge] Error in onload:', e);
                }
            }
            
            // Also try loadend
            if (xhr.onloadend) {
                try {
                    xhr.onloadend({type: 'loadend', target: xhr});
                    console.log('[AndroidBridge] onloadend triggered');
                } catch(e) {
                    console.error('[AndroidBridge] Error in onloadend:', e);
                }
            }
            
            pendingXHR.delete(id);
            console.log('[AndroidBridge] Request', id, 'completed');
        };
        
        // Override XMLHttpRequest
        const RealXHR = window.XMLHttpRequest;
        window.XMLHttpRequest = function() {
            const xhr = new RealXHR();
            const realOpen = xhr.open;
            const realSend = xhr.send;
            
            xhr.open = function(method, url) {
                this._url = url;
                this._intercept = url.includes('localhost') || url.includes('/upload');
                if (this._intercept) console.log('[AndroidBridge] Intercepting:', url);
                return realOpen.apply(this, arguments);
            };
            
            xhr.send = function(data) {
                if (!this._intercept) return realSend.call(this, data);
                
                console.log('[AndroidBridge] Handling intercepted request:', this._url);
                
                let url = null;
                if (data && data.get) url = data.get('url');
                
                // Check if this is a lesson content request
                const isLessonContent = this._url.includes('lesson-content') || this._url.includes('/lessons/');
                
                // Check if this is a course generation request
                const isCourseGeneration = this._url.includes('generate') || 
                                          this._url.includes('course') ||
                                          (!url && data && !isLessonContent);
                
                if (isLessonContent && window.Android && window.Android.generateLessonContent) {
                    // Generate lesson content using AI
                    console.log('[AndroidBridge] Generating lesson content with AI...');
                    
                    let lessonInfo = {
                        title: '',
                        description: '',
                        context: ''
                    };
                    
                    if (data && data.get) {
                        lessonInfo.title = data.get('title') || data.get('lessonTitle') || 'Lesson';
                        lessonInfo.description = data.get('description') || data.get('lessonDescription') || '';
                        lessonInfo.context = data.get('context') || data.get('courseContext') || '';
                    }
                    
                    console.log('[AndroidBridge] Lesson Info:', lessonInfo);
                    
                    const callbackName = 'lessonContentCallback_' + Date.now();
                    window[callbackName] = function(response) {
                        console.log('[AndroidBridge] Lesson content response:', response);
                        
                        const json = JSON.stringify(response);
                        Object.defineProperty(this, 'readyState', {writable: true, value: 4});
                        Object.defineProperty(this, 'status', {writable: true, value: response.success ? 200 : 500});
                        Object.defineProperty(this, 'response', {writable: true, value: json});
                        Object.defineProperty(this, 'responseText', {writable: true, value: json});
                        
                        this.getAllResponseHeaders = () => 'Content-Type: application/json\r\n';
                        this.getResponseHeader = () => 'application/json';
                        
                        if (this.onreadystatechange) this.onreadystatechange({type: 'readystatechange', target: this});
                        if (this.onload) this.onload({type: 'load', target: this});
                        if (this.onloadend) this.onloadend({type: 'loadend', target: this});
                        
                        console.log('[AndroidBridge] Lesson content generation complete!');
                        delete window[callbackName];
                    }.bind(this);
                    
                    window.Android.generateLessonContent(
                        lessonInfo.title,
                        lessonInfo.description,
                        lessonInfo.context,
                        callbackName
                    );
                    
                } else if (isCourseGeneration && window.Android && window.Android.generateCourseContent) {
                    // Use the unified course generation method
                    console.log('[AndroidBridge] Generating course with AI using unified method...');
                    
                    // Extract course details from FormData
                    let courseInfo = {
                        url: '',
                        extractedText: '',
                        title: 'Machine Learning',
                        difficulty: 'Beginner',
                        audience: 'Students',
                        prerequisites: 'None'
                    };
                    
                    if (data && data.get) {
                        courseInfo.url = data.get('url') || '';
                        courseInfo.extractedText = data.get('extracted_text') || '';
                        courseInfo.title = data.get('title') || courseInfo.title;
                        courseInfo.difficulty = data.get('difficulty') || courseInfo.difficulty;
                        courseInfo.audience = data.get('audience') || courseInfo.audience;
                        courseInfo.prerequisites = data.get('prerequisites') || courseInfo.prerequisites;
                    }
                    
                    console.log('[AndroidBridge] Course Info:', courseInfo);
                    
                    // Call unified generation method
                    const callbackName = 'courseGenCallback_' + Date.now();
                    window[callbackName] = function(response) {
                        console.log('[AndroidBridge] Course generation response:', response);
                        
                        // Transform AI response to match frontend structure
                        let finalResponse = {
                            success: response.success || false,
                            course_id: response.course_id || ('ai-' + Date.now()),
                            extracted_text: response.extracted_text || ''
                        };
                        
                        if (response.success && response.course) {
                            // Transform lessons to modules format
                            const lessons = response.course.lessons || [];
                            const modules = lessons.map((lesson, index) => ({
                                id: 'module-' + (index + 1),
                                title: lesson.title || ('Module ' + (index + 1)),
                                description: lesson.description || 'AI generated module',
                                duration: 60,
                                lessonCount: (lesson.topics || []).length,
                                status: index === 0 ? 'in-progress' : 'available',
                                lessons: (lesson.topics || ['Introduction', 'Core Concepts', 'Practice']).map((topic, tIndex) => ({
                                    id: `lesson-${index + 1}-${tIndex + 1}`,
                                    title: topic,
                                    description: lesson.description || 'Learn about ' + topic,
                                    duration: 20,
                                    status: index === 0 && tIndex === 0 ? 'in-progress' : 'available'
                                }))
                            }));
                            
                            finalResponse.course = {
                                title: response.course.title || 'AI Generated Course',
                                description: response.course.description || 'Course created with AI',
                                modules: modules.length > 0 ? modules : [
                                    {
                                        id: 'module-1',
                                        title: 'Introduction',
                                        description: 'Getting started',
                                        duration: 60,
                                        lessonCount: 2,
                                        status: 'in-progress',
                                        lessons: [
                                            {
                                                id: 'lesson-1-1',
                                                title: 'Overview',
                                                description: 'Course overview',
                                                duration: 30,
                                                status: 'in-progress'
                                            },
                                            {
                                                id: 'lesson-1-2',
                                                title: 'Getting Started',
                                                description: 'Begin your learning journey',
                                                duration: 30,
                                                status: 'available'
                                            }
                                        ]
                                    }
                                ]
                            };
                        } else {
                            // Error case - still provide valid structure
                            finalResponse.course = {
                                title: 'Error',
                                description: response.message || response.error || 'Failed to generate course',
                                modules: []
                            };
                        }
                        
                        const json = JSON.stringify(finalResponse);
                        Object.defineProperty(this, 'readyState', {writable: true, value: 4});
                        Object.defineProperty(this, 'status', {writable: true, value: response.success ? 200 : 500});
                        Object.defineProperty(this, 'response', {writable: true, value: json});
                        Object.defineProperty(this, 'responseText', {writable: true, value: json});
                        
                        this.getAllResponseHeaders = () => 'Content-Type: application/json\r\n';
                        this.getResponseHeader = () => 'application/json';
                        
                        if (this.onreadystatechange) this.onreadystatechange({type: 'readystatechange', target: this});
                        if (this.onload) this.onload({type: 'load', target: this});
                        if (this.onloadend) this.onloadend({type: 'loadend', target: this});
                        
                        console.log('[AndroidBridge] Course generation complete!');
                        delete window[callbackName];
                    }.bind(this);
                    
                    window.Android.generateCourseContent(
                        courseInfo.url,
                        courseInfo.extractedText,
                        courseInfo.title,
                        courseInfo.difficulty,
                        courseInfo.audience,
                        courseInfo.prerequisites,
                        callbackName
                    );
                    
                } else if (url && window.Android && window.Android.extractWebsiteContent) {
                    // Website extraction only (legacy path)
                    console.log('[AndroidBridge] Fetching:', url);
                    const id = xhrId++;
                    pendingXHR.set(id, this);
                    const callback = 'handleWebResult_' + id;
                    window[callback] = function(r) { window.handleWebResult(id, r); delete window[callback]; };
                    window.Android.extractWebsiteContent(url, callback);
                } else {
                    // No URL or Android, return mock
                    console.log('[AndroidBridge] No URL or Android not available, mocking');
                    setTimeout(function() {
                        const json = JSON.stringify({
                            success: true,
                            course_id: 'mock-' + Date.now(),
                            extracted_text: 'Please enter a website URL',
                            course: {
                                title: 'Sample Course',
                                description: 'A sample course for testing',
                                modules: [
                                    {
                                        id: 'module-1',
                                        title: 'Introduction',
                                        description: 'Getting started',
                                        duration: 60,
                                        lessonCount: 2,
                                        status: 'in-progress',
                                        lessons: [
                                            {
                                                id: 'lesson-1-1',
                                                title: 'Overview',
                                                description: 'Course overview',
                                                duration: 30,
                                                status: 'in-progress'
                                            },
                                            {
                                                id: 'lesson-1-2',
                                                title: 'Getting Started',
                                                description: 'Begin your learning journey',
                                                duration: 30,
                                                status: 'available'
                                            }
                                        ]
                                    }
                                ]
                            }
                        });
                        Object.defineProperty(this, 'readyState', {writable: true, value: 4});
                        Object.defineProperty(this, 'status', {writable: true, value: 200});
                        Object.defineProperty(this, 'response', {writable: true, value: json});
                        Object.defineProperty(this, 'responseText', {writable: true, value: json});
                        this.getAllResponseHeaders = () => 'Content-Type: application/json';
                        this.getResponseHeader = () => 'application/json';
                        if (this.onreadystatechange) this.onreadystatechange();
                        if (this.onload) this.onload();
                    }.bind(this), 200);
                }
            };
            
            return xhr;
        };
        
        console.log('[AndroidBridge] Ready!');
    </script>
    <script defer="defer" src="./static/js/main.9dbe6570.js"></script>
    <link href="./static/css/main.e6c13ad2.css" rel="stylesheet">
</head>
<body>
<noscript>You need to enable JavaScript to run this app.</noscript>
<div id="root"></div>
</body>
</html>