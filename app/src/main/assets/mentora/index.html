<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="./favicon.ico"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="theme-color" content="#000000"/>
    <meta name="description" content="Web site created using create-react-app"/>
    <link rel="apple-touch-icon" href="./logo192.png"/>
    <link rel="manifest" href="./manifest.json"/>
    <title>React App</title>
    <script>
        // Android Bridge - Must load BEFORE React app
        console.log('[AndroidBridge] Initializing...');
        
        window.isAndroidApp = true;
        
        // Store pending requests
        const pendingXHR = new Map();
        let xhrId = 0;
        
        // Handler for website extraction results
        window.handleWebResult = function(id, result) {
            console.log('[AndroidBridge] Got result for request', id);
            const xhr = pendingXHR.get(id);
            if (!xhr) return;
            
            const data = {
                success: result.success || false,
                course_id: 'android-' + Date.now(),
                extracted_text: result.text || '',
                course: {
                    title: result.title || 'Untitled',
                    description: result.url || '',
                    lessons: []
                }
            };
            
            const json = JSON.stringify(data);
            Object.defineProperty(xhr, 'readyState', {writable: true, value: 4});
            Object.defineProperty(xhr, 'status', {writable: true, value: result.success ? 200 : 500});
            Object.defineProperty(xhr, 'response', {writable: true, value: json});
            Object.defineProperty(xhr, 'responseText', {writable: true, value: json});
            
            xhr.getAllResponseHeaders = () => 'Content-Type: application/json';
            xhr.getResponseHeader = (n) => n === 'content-type' ? 'application/json' : null;
            
            if (xhr.onreadystatechange) xhr.onreadystatechange();
            if (xhr.onload) xhr.onload();
            
            pendingXHR.delete(id);
        };
        
        // Override XMLHttpRequest
        const RealXHR = window.XMLHttpRequest;
        window.XMLHttpRequest = function() {
            const xhr = new RealXHR();
            const realOpen = xhr.open;
            const realSend = xhr.send;
            
            xhr.open = function(method, url) {
                this._url = url;
                this._intercept = url.includes('localhost') || url.includes('/upload');
                if (this._intercept) console.log('[AndroidBridge] Intercepting:', url);
                return realOpen.apply(this, arguments);
            };
            
            xhr.send = function(data) {
                if (!this._intercept) return realSend.call(this, data);
                
                console.log('[AndroidBridge] Handling intercepted request');
                
                let url = null;
                if (data && data.get) url = data.get('url');
                
                if (url && window.Android && window.Android.extractWebsiteContent) {
                    console.log('[AndroidBridge] Fetching:', url);
                    const id = xhrId++;
                    pendingXHR.set(id, this);
                    const callback = 'handleWebResult_' + id;
                    window[callback] = function(r) { window.handleWebResult(id, r); delete window[callback]; };
                    window.Android.extractWebsiteContent(url, callback);
                } else {
                    console.log('[AndroidBridge] No URL or Android not available, mocking');
                    setTimeout(function() {
                        const json = JSON.stringify({
                            success: true,
                            course_id: 'mock-' + Date.now(),
                            extracted_text: 'Please enter a website URL',
                            course: {title: 'Sample', lessons: []}
                        });
                        Object.defineProperty(this, 'readyState', {writable: true, value: 4});
                        Object.defineProperty(this, 'status', {writable: true, value: 200});
                        Object.defineProperty(this, 'response', {writable: true, value: json});
                        Object.defineProperty(this, 'responseText', {writable: true, value: json});
                        this.getAllResponseHeaders = () => 'Content-Type: application/json';
                        this.getResponseHeader = () => 'application/json';
                        if (this.onreadystatechange) this.onreadystatechange();
                        if (this.onload) this.onload();
                    }.bind(this), 200);
                }
            };
            
            return xhr;
        };
        
        console.log('[AndroidBridge] Ready!');
    </script>
    <script defer="defer" src="./static/js/main.9dbe6570.js"></script>
    <link href="./static/css/main.e6c13ad2.css" rel="stylesheet">
</head>
<body>
<noscript>You need to enable JavaScript to run this app.</noscript>
<div id="root"></div>
</body>
</html>