<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="icon" href="./favicon.ico"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="theme-color" content="#000000"/>
    <meta name="description" content="Web site created using create-react-app"/>
    <link rel="apple-touch-icon" href="./logo192.png"/>
    <link rel="manifest" href="./manifest.json"/>
    <title>React App</title>
    <script>
        // Android Bridge - Must load BEFORE React app
        console.log('[AndroidBridge] Initializing...');
        
        window.isAndroidApp = true;
        
        // Store pending requests
        const pendingXHR = new Map();
        let xhrId = 0;
        
        // Handler for website extraction results
        window.handleWebResult = function(id, result) {
            console.log('[AndroidBridge] Got result for request', id, result);
            const xhr = pendingXHR.get(id);
            if (!xhr) {
                console.error('[AndroidBridge] No XHR found for request', id);
                return;
            }
            
            const data = {
                success: result.success || false,
                course_id: 'android-' + Date.now(),
                extracted_text: result.text || '',
                course: {
                    title: result.title || 'Untitled',
                    description: result.url || '',
                    lessons: []
                }
            };
            
            console.log('[AndroidBridge] Responding with:', data);
            const json = JSON.stringify(data);
            
            Object.defineProperty(xhr, 'readyState', {writable: true, value: 4});
            Object.defineProperty(xhr, 'status', {writable: true, value: result.success ? 200 : 500});
            Object.defineProperty(xhr, 'statusText', {writable: true, value: result.success ? 'OK' : 'Error'});
            Object.defineProperty(xhr, 'response', {writable: true, value: json});
            Object.defineProperty(xhr, 'responseText', {writable: true, value: json});
            Object.defineProperty(xhr, 'responseType', {writable: true, value: ''});
            
            xhr.getAllResponseHeaders = () => 'Content-Type: application/json\r\n';
            xhr.getResponseHeader = (n) => n.toLowerCase() === 'content-type' ? 'application/json' : null;
            
            console.log('[AndroidBridge] Triggering events...');
            
            // Trigger readystatechange first
            if (xhr.onreadystatechange) {
                try {
                    xhr.onreadystatechange({type: 'readystatechange', target: xhr});
                    console.log('[AndroidBridge] onreadystatechange triggered');
                } catch(e) {
                    console.error('[AndroidBridge] Error in onreadystatechange:', e);
                }
            }
            
            // Then trigger onload
            if (xhr.onload) {
                try {
                    xhr.onload({type: 'load', target: xhr, currentTarget: xhr});
                    console.log('[AndroidBridge] onload triggered');
                } catch(e) {
                    console.error('[AndroidBridge] Error in onload:', e);
                }
            }
            
            // Also try loadend
            if (xhr.onloadend) {
                try {
                    xhr.onloadend({type: 'loadend', target: xhr});
                    console.log('[AndroidBridge] onloadend triggered');
                } catch(e) {
                    console.error('[AndroidBridge] Error in onloadend:', e);
                }
            }
            
            pendingXHR.delete(id);
            console.log('[AndroidBridge] Request', id, 'completed');
        };
        
        // Override XMLHttpRequest
        const RealXHR = window.XMLHttpRequest;
        window.XMLHttpRequest = function() {
            const xhr = new RealXHR();
            const realOpen = xhr.open;
            const realSend = xhr.send;
            
            xhr.open = function(method, url) {
                this._url = url;
                this._intercept = url.includes('localhost') || url.includes('/upload');
                if (this._intercept) console.log('[AndroidBridge] Intercepting:', url);
                return realOpen.apply(this, arguments);
            };
            
            xhr.send = function(data) {
                if (!this._intercept) return realSend.call(this, data);
                
                console.log('[AndroidBridge] Handling intercepted request');
                
                let url = null;
                if (data && data.get) url = data.get('url');
                
                // Check if this is a course generation request (not just upload)
                const isCourseGeneration = this._url.includes('generate') || 
                                          this._url.includes('course') ||
                                          (!url && data); // Has data but no URL means it's generation
                
                if (url && window.Android && window.Android.extractWebsiteContent) {
                    // Website extraction
                    console.log('[AndroidBridge] Fetching:', url);
                    const id = xhrId++;
                    pendingXHR.set(id, this);
                    const callback = 'handleWebResult_' + id;
                    window[callback] = function(r) { window.handleWebResult(id, r); delete window[callback]; };
                    window.Android.extractWebsiteContent(url, callback);
                } else if (isCourseGeneration && window.Android && window.Android.generateText) {
                    // Course generation with AI
                    console.log('[AndroidBridge] Generating course with AI...');
                    
                    // Extract course details from FormData
                    let courseInfo = {};
                    if (data && data.get) {
                        courseInfo = {
                            title: data.get('title') || 'Machine Learning',
                            difficulty: data.get('difficulty') || 'Beginner',
                            audience: data.get('audience') || 'Students',
                            prerequisites: data.get('prerequisites') || 'None'
                        };
                    }
                    
                    // Create prompt for AI
                    const prompt = `Create a comprehensive course outline about ${courseInfo.title}.
Level: ${courseInfo.difficulty}
Target Audience: ${courseInfo.audience}
Prerequisites: ${courseInfo.prerequisites}

Generate a JSON course structure with:
- Course title and description
- 5-7 lessons with titles and brief descriptions
- Each lesson should have 3-5 topics

Format as JSON: {"title": "...", "description": "...", "lessons": [{"title": "...", "description": "...", "topics": [...]}]}`;
                    
                    console.log('[AndroidBridge] AI Prompt:', prompt);
                    
                    // Call AI to generate course
                    window.Android.generateText(prompt, function(aiResponse) {
                        console.log('[AndroidBridge] AI Response:', aiResponse);
                        
                        // Try to parse AI response as JSON
                        let course;
                        try {
                            course = JSON.parse(aiResponse);
                        } catch(e) {
                            // If AI didn't return valid JSON, create a structured response
                            console.warn('[AndroidBridge] AI response not JSON, structuring it...');
                            course = {
                                title: courseInfo.title,
                                description: aiResponse.substring(0, 200),
                                lessons: [
                                    {
                                        title: 'Introduction to ' + courseInfo.title,
                                        description: 'Getting started',
                                        topics: ['Overview', 'Key Concepts', 'Prerequisites']
                                    }
                                ]
                            };
                        }
                        
                        const responseData = {
                            success: true,
                            course: course,
                            message: 'Course generated with on-device AI'
                        };
                        
                        const json = JSON.stringify(responseData);
                        Object.defineProperty(this, 'readyState', {writable: true, value: 4});
                        Object.defineProperty(this, 'status', {writable: true, value: 200});
                        Object.defineProperty(this, 'response', {writable: true, value: json});
                        Object.defineProperty(this, 'responseText', {writable: true, value: json});
                        
                        this.getAllResponseHeaders = () => 'Content-Type: application/json\r\n';
                        this.getResponseHeader = () => 'application/json';
                        
                        if (this.onreadystatechange) this.onreadystatechange({type: 'readystatechange', target: this});
                        if (this.onload) this.onload({type: 'load', target: this});
                        
                        console.log('[AndroidBridge] Course generation complete!');
                    }.bind(this));
                } else {
                    // No URL or AI, return mock
                    console.log('[AndroidBridge] No URL or Android not available, mocking');
                    setTimeout(function() {
                        const json = JSON.stringify({
                            success: true,
                            course_id: 'mock-' + Date.now(),
                            extracted_text: 'Please enter a website URL',
                            course: {
                                title: 'Sample Course',
                                description: 'A sample course for testing',
                                lessons: [
                                    {
                                        title: 'Lesson 1: Introduction',
                                        description: 'Getting started with the basics',
                                        topics: ['Topic 1', 'Topic 2', 'Topic 3']
                                    }
                                ]
                            }
                        });
                        Object.defineProperty(this, 'readyState', {writable: true, value: 4});
                        Object.defineProperty(this, 'status', {writable: true, value: 200});
                        Object.defineProperty(this, 'response', {writable: true, value: json});
                        Object.defineProperty(this, 'responseText', {writable: true, value: json});
                        this.getAllResponseHeaders = () => 'Content-Type: application/json';
                        this.getResponseHeader = () => 'application/json';
                        if (this.onreadystatechange) this.onreadystatechange();
                        if (this.onload) this.onload();
                    }.bind(this), 200);
                }
            };
            
            return xhr;
        };
        
        console.log('[AndroidBridge] Ready!');
    </script>
    <script defer="defer" src="./static/js/main.9dbe6570.js"></script>
    <link href="./static/css/main.e6c13ad2.css" rel="stylesheet">
</head>
<body>
<noscript>You need to enable JavaScript to run this app.</noscript>
<div id="root"></div>
</body>
</html>